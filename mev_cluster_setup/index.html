<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>MEV cluster setup - MEV REST API</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../style.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "MEV cluster setup";
    var mkdocs_page_input_path = "mev_cluster_setup.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> MEV REST API</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../general_architecture/">Architecture</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Installation and Setup</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../install/">Preliminaries</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">MEV cluster setup</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#creating-a-host-machine">Creating a host machine</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#software-requirements-of-the-host-machine">Software requirements of the host machine</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cloning-and-starting-the-application">Cloning and starting the application</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#restarting-only-the-application-container">Restarting only the application container</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../setup_configuration/">Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../cromwell_setup/">Cromwell job runner setup</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../api/">Intro</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Data Structures</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../attributes/">Attributes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../elements/">Observations and Features</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../observation_and_feature_sets/">ObservationSet and FeatureSets</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../workspaces/">Workspaces</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../metadata/">Workspace metadata</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Resources</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../resources/">General info</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../resource_types/">Resource types</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../resource_metadata/">Resource metadata</a>
                </li>
    </ul>
                </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../auth/">Authentication</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../operations/">Operation concepts</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../creating_analyses/">Creating new analyses/operations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../example_workflow/">Workflow and analysis concepts</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">MEV REST API</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Installation and Setup &raquo;</li>
        
      
    
    <li>MEV cluster setup</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/web-mev/mev-backend/edit/master/docs/mev_cluster_setup.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="the-mev-application-cluster"><a class="toclink" href="#the-mev-application-cluster">The MEV application cluster</a></h2>
<p>This section of the installation instructions describes:
- How to set up a new host for WebMEV
- Basic host machine configuration
- Starting WebMEV on the host, regardless of your hardware</p>
<h3 id="creating-a-host-machine"><a class="toclink" href="#creating-a-host-machine">Creating a host machine</a></h3>
<p><em>Note: If you wish to run WebMEV as a local application (i.e. not using a cloud provider), you may skip this section.</em></p>
<p><strong>Starting the machine</strong>
Using the instructions specific to your cloud platform, start a new virtual machine. Note that we have only run WebMEV on a Debian-based Linux system and do not plan to support other operating systems. However, by using Docker, we anticipate that WebMEV <em>should</em> be portalbe to any system capable of running Docker.</p>
<p>There is relatively little that is specific to WebMEV about this process, but we make note of the following considerations:</p>
<ul>
<li>
<p><strong>Ports:</strong> The public-facing nginx server used by MEV expects both 80 (for http) and 443 (for https) to be open, although the choice of protocol is up to you.</p>
</li>
<li>
<p><strong>Disk size:</strong> In addition to the application itself, the host machine will maintain a temporary cache of user data and any Docker images used to run local Docker-based jobs. Choose your disk size to accommodate this anticipated load.</p>
</li>
<li>
<p><strong>Processor/RAM requirements:</strong> The resource requirements for WebMEV itself are not substantial, but you should aim to size your VM to successfully handle your most resource-intensive analyses. Recall that local Docker-based jobs will consume resources of the host machine, so you should have some idea of the resources required for each type of analysis that you plan to run using the local Docker-based job runner. We advise at least 4vCPU and &gt;8Gb RAM, although this may change as we see additional stress or more intensive analysis requirements. </p>
</li>
</ul>
<p>In theory, one could execute large, resource-intensive alignment jobs using the local Docker-based job engine, but this would incur substantial costs for maintaining a large on-demand virtual machine. Thus, we advise that local Docker-based jobs have relatively small resource requirements and larger, resource and time-intensive tasks be implemented to make use of the remote job runners such as Cromwell.</p>
<h3 id="software-requirements-of-the-host-machine"><a class="toclink" href="#software-requirements-of-the-host-machine">Software requirements of the host machine</a></h3>
<p>WebMEV uses <code>docker-compose</code> and thus requires that both <code>Docker</code> and <code>docker-compose</code> are installed on the host system. Refer to the respective projects for installation instructions.</p>
<p>Other requirements include <code>git</code> and your favorite text editor.</p>
<h3 id="cloning-and-starting-the-application"><a class="toclink" href="#cloning-and-starting-the-application">Cloning and starting the application</a></h3>
<p>The WebMEV application is architected as a collection of Docker images which is orchestrated/managed by <code>docker-compose</code>.  As mentioned previously, you will need to have Docker and docker-compose installed.</p>
<p>The application includes three containers with the following responsibilities.
- <code>nginx</code>: Handles communication to the outside world. Serves static files directly and forwards other requests to the application server (gunicorn), which is packaged in the <code>api</code> container.
- <code>db</code>: The database container. Currently using postgres as we require saving of JSON-format data structures
- <code>api</code>: The main application container. This container wraps several components, including the web application (written in Django), redis for cache and job queueing, and gunicorn as the application server.</p>
<p><img alt="" src="../docker_arch.svg" /></p>
<p>First, we clone the repository locally:</p>
<pre class="codehilite"><code>git clone https://github.com/web-mev/mev-backend.git</code></pre>


<p><strong>Setting the required environment variables</strong>
Regardless of whether you are running in development or production, mode, you will need to supply various environment variables to properly configure WebMEV. In the root of the repository is a file named <code>env_vars.template.txt</code>.  Edit that with usernames, passwords, etc. as necessary.</p>
<p>For more detailed information on configuration, see <a href="../setup_configuration/">Configuration</a></p>
<p><strong>To start the application in local <em>development</em> mode:</strong></p>
<p>In development mode, the application server (gunicorn) does not start automatically as the container starts.  Rather, all the containers are started but the application container (named <code>api</code>) remains idle.  This allows us to mount a local directory where we can dynamically edit the code and immediately see changes without having to rebuild the entire cluster.  </p>
<p><strong>Note that the Django <code>DEBUG</code> argument is set to <code>True</code> in this dev mode, so be mindful of this if the server is exposed to the public/internet.</strong></p>
<p>Development mode requires you to have a file containing your environment variables that is named <code>env_vars.dev.txt</code>. Thus, copy the file and edit with your passwords and other info:</p>
<pre class="codehilite"><code>cp env_vars.template.txt env_vars.dev.txt
# edit env_vars.dev.txt as necessary</code></pre>


<p>Now we can start the docker-compose cluster. Run:</p>
<pre class="codehilite"><code>docker-compose up -d --build</code></pre>


<p>This builds all the containers and runs in "detached" mode (<code>-d</code>).  By default, <code>docker-compose</code> will look for the <code>docker-compose.yml</code> file which, by design, puts us in <em>development</em> mode.  The current directory on the host machine (the directory where the MEV repository was cloned) will be mounted at <code>/workspace</code> inside the <code>api</code> container.</p>
<p>Next, enter the container with:</p>
<pre class="codehilite"><code>docker-compose exec api /bin/bash</code></pre>


<p>You may optionally choose to add the <code>-u 0</code> flag which logs you into the <code>api</code> container as root.</p>
<p>Once inside, run the following:</p>
<pre class="codehilite"><code>cd /workspace/mev
source startup_for_local_dev.sh</code></pre>


<p>This will run some database migrations and other preliminaries, but will <strong>not</strong> actually start the gunicorn application server.  To do that, you must then run:</p>
<pre class="codehilite"><code>cd /workspace/mev
gunicorn mev.wsgi:application --bind 0.0.0.0:8000</code></pre>


<p>(note the <code>cd</code> at the top since the <code>startup.sh</code> script ends up moving you into the <code>/www</code> directory).  The <code>bind</code> argument should have the port set to 8000 as this is how the NGINX container communicates over the internal docker-compose network.</p>
<p>Following all that, <strong>the application should be running on port 8081</strong> (e.g. http://127.0.0.1:8081/api/)</p>
<p>If you are interested, note that additional gunicorn configuration parameters can be specified (see https://docs.gunicorn.org/en/latest/configure.html). </p>
<p>By stopping the gunicorn server (Ctrl+C), you can make local edits (i.e. on your host machine) to your code (which is, again, available within the container via the volume mount) and immediately restart the server to see the changes.  The unit test suite can also be run in this manner with</p>
<pre class="codehilite"><code>python3 /workspace/mev/manage.py test</code></pre>


<p><strong>To start the application in <em>production</em> mode:</strong></p>
<p>In production mode, the application server <em>will</em> be started following the usual startup steps contained in <code>mev/startup.sh</code>.</p>
<p>In the root of the repository (where the <code>docker-compose.prod.yml</code> file resides) run:</p>
<pre class="codehilite"><code>docker-compose -f docker-compose.prod.yml up -d --build</code></pre>


<p>This should start everything up.  On occasion, if you are very quick to navigate to the site, NGINX will issue a 502 bad gateway error.  However, a refresh or two should eventually reach the site as expected.  </p>
<p>In production mode, Django debugging is turned off, so any errors will be reported as generic 500 server errors without any corresponding debug details.</p>
<p>### Stopping the application</p>
<p>To shut down the application (in verbose mode), run</p>
<pre class="codehilite"><code>docker-compose down -v</code></pre>


<h3 id="restarting-only-the-application-container"><a class="toclink" href="#restarting-only-the-application-container">Restarting only the application container</a></h3>
<p>If you need to update the API code and wish to preserve the remainder of the application, such as database rows, etc. then you can update the <code>api</code> container independently. On the host machine, run: </p>
<pre class="codehilite"><code>docker-compose -f docker-compose.prod.yml up --build --force-recreate --no-deps -d api</code></pre>


<p>Of course updates to the database structure will require database migrations, which is challenging if you wish to maintain the existing rows. We do not cover that here.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../setup_configuration/" class="btn btn-neutral float-right" title="Configuration">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../install/" class="btn btn-neutral" title="Preliminaries"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/web-mev/mev-backend/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../install/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../setup_configuration/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
