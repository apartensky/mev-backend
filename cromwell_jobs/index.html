<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Cromwell jobs - MEV REST API</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../style.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Cromwell jobs";
    var mkdocs_page_input_path = "cromwell_jobs.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> MEV REST API</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../general_architecture/">Architecture</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Installation and Setup</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../install/">Preliminaries</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mev_cluster_setup/">MEV cluster setup</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../setup_configuration/">Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../cromwell_setup/">Cromwell job runner setup</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../api/">Intro</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Data Structures</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../attributes/">Attributes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../elements/">Observations and Features</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../observation_and_feature_sets/">ObservationSet and FeatureSets</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../workspaces/">Workspaces</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../metadata/">Workspace metadata</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Resources</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../resources/">General info</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../resource_types/">Resource types</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../resource_metadata/">Resource metadata</a>
                </li>
    </ul>
                </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../auth/">Authentication</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../operations/">Operation concepts</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../creating_analyses/">Creating new analyses/operations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../example_workflow/">Workflow and analysis concepts</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">MEV REST API</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Cromwell jobs</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/web-mev/mev-backend/edit/master/docs/cromwell_jobs.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="cromwell-setup"><a class="toclink" href="#cromwell-setup">Cromwell setup</a></h2>
<h2 id="remote-cromwell-based-jobs"><a class="toclink" href="#remote-cromwell-based-jobs">Remote Cromwell-based jobs</a></h2>
<p>For a Cromwell-based job, we include all the workflow components in one or more
WDL-format files.</p>
<p>In those WDL files, workflow authors specify the Docker image they wish to use, e.g.</p>
<pre class="codehilite"><code>task SomeTask {
    ...&lt;other content&gt;

    runtime {
        ...
        docker: &quot;docker.io/&lt;username&gt;/&lt;image name&gt;:&lt;tag&gt;&quot;
        ...
    }
}</code></pre>


<p>For our purposes with MEV, we will end up replacing these tags which appropriately versioned/tagged images. The process is as follows:
- The repository is cloned onto the MEV instance
- When the workflow is ingested into MEV, the github commit hash is noted. As an example take this to be <code>"abc123"</code>
- We parse the WDL files and collect all unique docker image names from <em>all</em> WDL files. Uniqueness is determined by the combination of username and image name. It does <em>not</em> include the tag, since that will be changed anyway (see below). Two docker images that differ in only their tag will be rejected.
- For each of those unique Docker images we look for an image-specific Dockerfile, where the name of the Dockerfile is determined by the name of the corresponding Docker image. For example, consider that we parse <code>docker.io/myuser/foo</code> from our WDL files. We would then look for a file at <code>docker/Dockerfile.foo</code> among the repository files. 
- We then build an image from the Dockerfile specification and tag it with the github commit hash. Thus, the final image (built from <code>docker/Dockerfile.foo</code>) would be <code>myuser/foo:abc123</code>
- An exact search/replace for the image specification is performed on the WDL files. Thus, if we parsed <code>docker.io/myuser/foo</code> was parsed from the WDL file(s), we replace that with <code>docker.io/myuser/foo:abc123</code></p>
<p>In this way, the Docker images can be unambiguously associated with the github commit that generated them. The downside of this approach is that the workflow files we use <em>within</em> MEV are not <em>exactly</em> the same as they are seen in github. Since we can't know the git commit hash up front (i.e. prior to commit), we can't tag the Docker images correctly in the first place. <em>However</em>, the <code>Operation</code> info pulled from the database will contain that hash. From there, interested users can go to the repository history and find the exact state of the repository that created their analysis; the only difference would be the references to the Docker images. Users can then view the Docker image that was used (e.g. <code>docker.io/myuser/foo</code>), append the hash (e.g. <code>abc123</code>) and be able to find the exact image version(s) that ran their analysis. Importantly, the commands do not change in our ingestion process.</p>
<p>This tradeoff seemed preferable to the option where we establish tags prior to commit and push those tagged Docker images to Dockerhub. In that case, developers had to be sure not to overwrite earlier images or had to ensure a system for keeping them all up to date/in-sync.</p>
<h2 id="dealing-with-cromwell-jobs"><a class="toclink" href="#dealing-with-cromwell-jobs">Dealing with Cromwell jobs</a></h2>
<p>After we have a set of WDL files, we also have an associated JSON-format inputs file.</p>
<p>In general, that inputs file can have user-supplied items like strings, numbers, and files (e.g. fastq files). However, there may be other file-based resources required which are not something that the user "owns". An example would be a genome index as required by an alignment. The user should only have to specify their reference genome-- they should not have to deal with the creation or maintenance of those files.</p>
<p>To speak concretely about this, imagine we have some simple alignment workflow. For inputs, we require one or more fastq files and a reference to align against. One way to accomplish this could be:</p>
<pre class="codehilite"><code>{
  &quot;SomeWorkflow.fastq_files&quot;: &quot;Array[File]&quot;,
  &quot;SomeWorkflow.genome&quot;: &quot;String&quot;
}</code></pre>


<p>Then, in the repository, we have a tab-delimited file which gives us the ability to map the genome string to one or more files (e.g. index files) that are associated with that genome. </p>
<p>For instance, if the final json was:</p>
<pre class="codehilite"><code>{
  &quot;SomeWorkflow.fastq_files&quot;: [
      &quot;gs://mybucket/fileA_R1.fastq.gz&quot;,
      &quot;gs://mybucket/fileB_R1.fastq.gz&quot;,
    ],
  &quot;SomeWorkflow.genome&quot;: &quot;GRCh38_human&quot;
}</code></pre>


<p>we could have a file in the repository that has:</p>
<pre class="codehilite"><code>{
    &quot;GRCh38_human&quot;: {
        &quot;index&quot;: &quot;/path/to/human.index&quot;,
        &quot;gtf&quot;: &quot;/path/to/human.gtf&quot;
    },
    &quot;GRCm38_mouse&quot;: {
        &quot;index&quot;: &quot;/path/to/mouse.index&quot;,
        &quot;gtf&quot;: &quot;/path/to/mouse.gtf&quot;
    }
}</code></pre>


<p>Then, in the WDL, it will perform that mapping to use the proper index.
NOTE: Using WDL's <code>read_json</code> does not seem to work as expected.</p>
<p><strong>Option 2</strong>
Instead of having a separate file for the index, gtf, etc. we could hard-code it into the WDL file itself. Since the WDL is version-controlled, this is not the worst solution.</p>
<p><strong>Option 3</strong>
Use a converter. Can we make a converter class that will take the genome string and give us the various files we need? Don't think so- would require the converter to look at the repo and grab that file.</p>
<p>What about a "mapper" converter. Given a string (e.g. "GRCh38_human"), it loads a file (with some standard name) that looks like:</p>
<pre class="codehilite"><code>{
    &quot;GRCh38_human&quot;: {
        &quot;Workflow.index&quot;: &quot;/path/to/human.index&quot;,
        &quot;Workflow.gtf&quot;: &quot;/path/to/human.gtf&quot;
    },
    &quot;GRCm38_mouse&quot;: {
        &quot;Workflow.index&quot;: &quot;/path/to/mouse.index&quot;,
        &quot;Workflow.gtf&quot;: &quot;/path/to/mouse.gtf&quot;
    }
}</code></pre>


<p>Note that the keys would be the variable names (as given in the <code>inputs.json</code> file). By using the user-supplied key/choice (GRCh38_human), we can add those values to the <code>inputs.json</code> (along with the other values)</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/web-mev/mev-backend/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
